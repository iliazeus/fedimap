<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <script src="https://unpkg.com/cytoscape@3.25.0/dist/cytoscape.min.js"></script>
  <script src="ap.js"></script>
  <style>
    #container {
      position: absolute;
      top: 0;
      left: 0;
      z-index: -1;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .error {
      color: red;
    }
  </style>
  <script>
    window.onload = async () => {
      const corsProxyPrefix = "https://corsproxy.io?";

      const cy = (window.cy = cytoscape({
        container: document.getElementById("container"),
        minZoom: 0.5,
        maxZoom: 2,
        wheelSensitivity: 0.5,
        style: [
          {
            selector: "node",
            style: {
              label: "data(preferredUsername)",
              "background-image": (el) => {
                const icon = el.data("icon");
                if (!icon?.url) return undefined;
                return corsProxyPrefix + encodeURIComponent(icon.url);
              },
              "background-image-crossorigin": "anonymous",
              "background-fit": "contain",
            },
          },
          {
            selector: "node.stub",
            style: {
              display: "none",
            },
          },
          {
            selector: "node.loading",
            style: {
              label: (el) => "⏳ " + el.data("preferredUsername"),
            },
          },
          {
            selector: "node.error",
            style: {
              label: (el) => "‼️ " + el.data("preferredUsername"),
            },
          },
          {
            selector: "edge",
            style: {
              "curve-style": "bezier",
              "target-arrow-shape": "triangle",
            },
          },
          {
            selector: "edge.stub",
            style: {
              display: "none",
            },
          },
        ],
      }));

      cy.scratch(
        "ap",
        new APContext({
          fetch: (url, opts) =>
            APContext.niceFetch(url, {
              ...opts,
              timeout: 30000,
              corsProxyPrefix,
              maxRetryCount: 5,
            }),
        })
      );

      cy.on("dblclick", (e) => {
        if (!e.target.isNode()) return;
        window.open(e.target.data("id"), "_blank");
      });

      const addProfile = async (cy, profile, { log, signal } = {}) => {
        let profileNode;

        try {
          const ap = cy.scratch("ap");

          log?.(`loading ${profile}`);

          try {
            await window.fetch(
              "https://corsproxy.io/?" +
                encodeURIComponent("https://www.google.com"),
              { method: "head" }
            );
          } catch {
            throw new Error("corsproxy.io is not accessible");
          }

          profile = await ap.object(profile);

          {
            const _log = log;
            log = (s) => _log?.(`${profile.preferredUsername}: ${s}`);
          }

          log(`loading profile`);

          profileNode = cy.$id(profile.id);

          if (profileNode.empty()) {
            cy.add({ data: profile, classes: ["loading"] });
            profileNode = cy.$id(profile.id);
          } else if (profileNode.hasClass("stub")) {
            profileNode.data(profile);
            profileNode.removeClass("stub");
            profileNode.addClass("loading");
          } else {
            profileNode.addClass("loading");
            profileNode.connectedEdges().addClass("stub");
          }

          profileNode
            .layout({
              name: "random",
              boundingBox: {
                x1: -cy.width() / 8,
                y1: -cy.height() / 8,
                x2: cy.width() / 8,
                y2: cy.height() / 8,
              },
              animate: true,
              fit: true,
            })
            .run();

          log(`loading following`);

          const follows = await ap.object(profile.following);
          let loadedFollows = 0;
          for await (let follow of ap.collection(follows)) {
            signal?.throwIfAborted();

            log(`loading follows: ${loadedFollows}/${follows.totalItems}`);

            let node = cy.$id(ap.id(follow));
            if (node.empty()) {
              cy.add({ data: { id: ap.id(follow) }, classes: ["stub"] });
              node = cy.$id(ap.id(follow));
            }

            const edgeId = profile.id + "::" + ap.id(follow);
            let edge = cy.$id(edgeId);

            if (edge.empty()) {
              cy.add({
                data: { id: edgeId, source: profile.id, target: ap.id(follow) },
              });
              edge = cy.$id(edgeId);
            } else {
              edge.removeClass("stub");
            }

            loadedFollows += 1;
          }

          log(`loading followers`);

          const followers = await ap.object(profile.followers);
          let loadedFollowers = 0;
          for await (let follower of ap.collection(followers)) {
            signal?.throwIfAborted();

            log(
              `loading followers: ${loadedFollowers}/${followers.totalItems}`
            );

            let node = cy.$id(ap.id(follower));
            if (node.empty()) {
              cy.add({ data: { id: ap.id(follower) }, classes: ["stub"] });
              node = cy.$id(ap.id(follower));
            }

            const edgeId = ap.id(follower) + "::" + profile.id;
            let edge = cy.$id(edgeId);

            if (edge.empty()) {
              cy.add({
                data: {
                  id: edgeId,
                  source: ap.id(follower),
                  target: profile.id,
                },
              });
              edge = cy.$id(edgeId);
            } else {
              edge.removeClass("stub");
            }

            loadedFollowers += 1;
          }

          log(`done`);
        } catch (error) {
          profileNode?.addClass("error");
          throw error;
        } finally {
          profileNode?.removeClass("loading");
        }
      };

      const input = document.getElementById("profile");
      const form = document.getElementById("form");

      const tasks = document.getElementById("tasks");
      const taskTemplate = document.getElementById("task-template");

      input.focus();

      form.onsubmit = async (e) => {
        e.preventDefault();

        if (!input.value) return;
        const profile = input.value;
        input.value = "";

        const controller = new AbortController();

        const task = taskTemplate.content.firstChild.cloneNode(true);
        task.querySelector(".text").innerText = `loading ${input.value}`;
        task.querySelector("button").onclick = () => controller.abort();
        tasks.appendChild(task);

        const button = task.querySelector("button");
        const status = task.querySelector(".text");

        try {
          await addProfile(cy, profile, {
            signal: controller.signal,
            log: (s) => (status.innerText = s),
          });

          task.remove();
        } catch (e) {
          status.classList.add("error");
          status.innerText = profile + ": " + String(e.message);

          button.onclick = null;
          button.innerText = "Dismiss";
          button.onclick = () => task.remove();
        } finally {
        }
      };
    };
  </script>
  <body>
    <div>
      <small>
        <p>
          Type or paste the URL or ID of a profile, then click "Add" or press
          Enter.
        </p>
        <p>
          Double click or double tap a node to open the profile in a new tab.
        </p>
        <p>
          Each profile has to be added manually; this app will <em>not</em> load
          them automatically, it only shows the connections.
        </p>
      </small>
    </div>
    <form id="form">
      <input focused id="profile" placeholder="Profile URL" />
      <input type="submit" value="Add" />
    </form>
    <div id="tasks"></div>
    <div id="container"></div>
    <template id="task-template"
      ><div>
        <small>
          <p><button>Abort</button> <span class="text"></span></p>
        </small></div
    ></template>
  </body>
</html>
